<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ data.main_subject | default("Study Notes") }}</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-W8Ew2Ff7L2tG8dM6e7Wc2v8S7MhM8S6F9L4D5J1T7kL9D2sF1P4t0M8J7tG6V8K5" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" integrity="sha384-zIq6Hj4w6Z2F8d5Z2F8tM6F9L4D5J1T7kL9D2sF1P4t0M8J7tG6V8K5" crossorigin="anonymous"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/mhchem.min.js"></script>
    
    <style>
        /* General PDF Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0.75in;
            font-size: {{ "11pt" if is_easy_read else "10pt" }};
            color: {{ colors.text_dark }};
        }
        
        /* Typography and Layout */
        h1 {
            color: {{ colors.primary_dark }};
            font-size: 26pt;
            text-align: center;
            margin-bottom: 20pt;
            margin-top: 10pt;
        }
        
        /* Section Header Styling */
        .section-header {
            background-color: {{ colors.primary }};
            color: white;
            padding: 8pt 15pt;
            margin-top: 20pt;
            margin-bottom: 0pt;
            font-weight: bold;
            font-size: 14pt;
        }
        
        .item-list {
            padding-bottom: {{ "15pt" if is_easy_read else "10pt" }};
        }
        
        /* Paragraph/List Item Styling */
        p {
            margin-top: {{ "6pt" if is_easy_read else "3pt" }};
            margin-bottom: {{ "6pt" if is_easy_read else "3pt" }};
            line-height: {{ "1.6" if is_easy_read else "1.4" }};
            padding-left: 15pt;
            text-indent: -15pt; /* Creates a hanging indent for the list bullet */
        }
        
        .topic-head {
            font-weight: bold;
            color: {{ colors.text_medium }};
            margin-top: 10pt;
            margin-left: 5pt;
            text-indent: 0;
            padding-left: 0;
        }

        /* Highlighting and Links */
        .highlight-text {
            background-color: {{ colors.bg_highlight }};
            color: {{ colors.accent }};
            font-weight: bold;
        }
        .timestamp-link {
            color: {{ colors.link }};
            font-weight: bold;
            font-size: 8pt;
            text-decoration: none;
            margin-left: 5pt;
        }
        
        /* Footer for Page Numbers (WeasyPrint @page rules) */
        @page {
            size: letter;
            margin: 0.75in;
            @bottom-left {
                content: "Generated by AI Notes Generator";
                font-size: 8pt;
                color: {{ colors.text_light }};
            }
            @bottom-right {
                content: "Page " counter(page) " of " counter(pages);
                font-size: 8pt;
                color: {{ colors.text_light }};
            }
        }
        
        /* KaTeX fixes for WeasyPrint */
        .katex-display { 
            margin: 1em 0 !important; 
            text-align: center !important; 
        }

    </style>
</head>
<body>

    <h1>{{ data.main_subject | default("Video Study Notes") }}</h1>

    {% for key, content in data.items() %}
        {% if key != "main_subject" and content and content is iterable %}
            {% set heading = key.replace("_", " ").title() %}
            {% set icon = section_icons.get(key, "ðŸ“Œ") %}

            <div class="section-header">{{ icon }} {{ heading }}</div>

            <div class="item-list">
                {% if key == 'topic_breakdown' %}
                    {% for topic in content %}
                        {% if topic.topic %}
                            <p class="topic-head">â€¢ {{ topic.topic }}</p>
                        {% endif %}
                        {% for detail in topic.details %}
                            {% set text_content = detail.detail | default(detail.text) | default(detail.content) %}
                            {% if text_content %}
                                <p>â€¢ {{ text_content | safe }} {{ detail.timestamp_html | safe }}</p>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                {% else %}
                    {% for item in content %}
                        {% set text_content = item.formula_or_principle | default(item.term) | default(item.insight) | default(item.point) | default(item.text) | default(item.mistake) | default(item.definition) %}
                        {% if text_content %}
                            <p>â€¢ {{ text_content | safe }} {{ item.timestamp_html | safe }}</p>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            
        {% endif %}
    {% endfor %}

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var elements = document.body.querySelectorAll('p, div, span, li, dt, dd');

            elements.forEach(function(el) {
                // Find and render $$...$$ (Display mode)
                el.innerHTML = el.innerHTML.replace(/\$\$([\s\S]*?)\$\$/g, function(match, formula) {
                    try {
                        return '<div class="katex-display">' + katex.renderToString(formula.trim(), {
                            throwOnError: false, 
                            displayMode: true 
                        }) + '</div>';
                    } catch (e) {
                        return match; 
                    }
                });

                // Find and render $...$ (Inline mode)
                el.innerHTML = el.innerHTML.replace(/\$([^$]+)\$/g, function(match, formula) {
                    // Exclude links and already processed blocks
                    if(el.closest('.timestamp-link')) return match; 
                    try {
                        return katex.renderToString(formula.trim(), {
                            throwOnError: false, 
                            displayMode: false 
                        });
                    } catch (e) {
                        return match;
                    }
                });
            });
        });
    </script>
</body>
</html>
